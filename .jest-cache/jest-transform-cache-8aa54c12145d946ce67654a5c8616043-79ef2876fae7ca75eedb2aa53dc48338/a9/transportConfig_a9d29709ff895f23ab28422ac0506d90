8122f83612381763b3356f0527693dc7
"use strict";
/**
 * Transport Configuration for n8n MCP Server
 *
 * Provides transport type detection and configuration for different deployment scenarios.
 * Supports both stdio (local development) and SSE (remote/web access) transports.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ENV_CONFIG = exports.DEFAULT_CONFIGS = exports.TransportConfigSchema = void 0;
exports.detectTransportConfig = detectTransportConfig;
exports.validateTransportConfig = validateTransportConfig;
exports.getServerUrl = getServerUrl;
exports.parseConfigFromEnv = parseConfigFromEnv;
const zod_1 = require("zod");
// Transport configuration schema
exports.TransportConfigSchema = zod_1.z.object({
    type: zod_1.z.enum(['stdio', 'sse']).default('stdio'),
    sse: zod_1.z
        .object({
        port: zod_1.z.number().min(1024).max(65535).default(8080),
        endpoint: zod_1.z.string().default('/sse'),
        host: zod_1.z.string().default('localhost'),
        cors: zod_1.z
            .object({
            enabled: zod_1.z.boolean().default(true),
            origins: zod_1.z.array(zod_1.z.string()).default(['*']),
            credentials: zod_1.z.boolean().default(false),
        })
            .default({}),
        healthCheck: zod_1.z
            .object({
            enabled: zod_1.z.boolean().default(true),
            endpoint: zod_1.z.string().default('/health'),
        })
            .default({}),
    })
        .optional(),
});
/**
 * Default transport configurations for different environments
 */
exports.DEFAULT_CONFIGS = {
    development: {
        type: 'stdio',
    },
    production: {
        type: 'sse',
        sse: {
            port: 8080,
            endpoint: '/sse',
            host: '0.0.0.0',
            cors: {
                enabled: true,
                origins: ['*'],
                credentials: false,
            },
            healthCheck: {
                enabled: true,
                endpoint: '/health',
            },
        },
    },
    web: {
        type: 'sse',
        sse: {
            port: process.env.PORT ? parseInt(process.env.PORT) : 3000,
            endpoint: '/sse',
            host: '0.0.0.0',
            cors: {
                enabled: true,
                origins: process.env.CORS_ORIGINS?.split(',') || ['*'],
                credentials: true,
            },
            healthCheck: {
                enabled: true,
                endpoint: '/health',
            },
        },
    },
};
/**
 * Detect appropriate transport configuration based on environment
 */
function detectTransportConfig() {
    // Check environment variables for explicit transport type
    const transportType = process.env.N8N_MCP_TRANSPORT;
    if (transportType === 'sse') {
        return exports.DEFAULT_CONFIGS.web;
    }
    if (transportType === 'stdio') {
        return exports.DEFAULT_CONFIGS.development;
    }
    // Auto-detect based on environment
    if (process.env.NODE_ENV === 'production' || process.env.PORT) {
        return exports.DEFAULT_CONFIGS.web;
    }
    // Check if running in a web environment (Railway, Vercel, etc.)
    if (process.env.RAILWAY_ENVIRONMENT || process.env.VERCEL || process.env.RENDER) {
        return exports.DEFAULT_CONFIGS.web;
    }
    // Default to stdio for local development
    return exports.DEFAULT_CONFIGS.development;
}
/**
 * Validate and normalize transport configuration
 */
function validateTransportConfig(config) {
    return exports.TransportConfigSchema.parse(config);
}
/**
 * Get SSE server URL from configuration
 */
function getServerUrl(config) {
    if (config.type !== 'sse' || !config.sse) {
        return null;
    }
    const { host, port, endpoint } = config.sse;
    const protocol = port === 443 ? 'https' : 'http';
    return `${protocol}://${host}:${port}${endpoint}`;
}
/**
 * Environment variable configuration helpers
 */
exports.ENV_CONFIG = {
    // Transport type selection
    TRANSPORT_TYPE: 'N8N_MCP_TRANSPORT', // 'stdio' | 'sse'
    // SSE configuration
    SSE_PORT: 'N8N_MCP_SSE_PORT',
    SSE_HOST: 'N8N_MCP_SSE_HOST',
    SSE_ENDPOINT: 'N8N_MCP_SSE_ENDPOINT',
    // CORS configuration
    CORS_ORIGINS: 'N8N_MCP_CORS_ORIGINS', // comma-separated list
    CORS_CREDENTIALS: 'N8N_MCP_CORS_CREDENTIALS', // 'true' | 'false'
    // Health check configuration
    HEALTH_CHECK_ENABLED: 'N8N_MCP_HEALTH_CHECK_ENABLED',
    HEALTH_CHECK_ENDPOINT: 'N8N_MCP_HEALTH_CHECK_ENDPOINT',
};
/**
 * Parse transport configuration from environment variables
 */
function parseConfigFromEnv() {
    const config = {};
    // Transport type
    if (process.env[exports.ENV_CONFIG.TRANSPORT_TYPE]) {
        config.type = process.env[exports.ENV_CONFIG.TRANSPORT_TYPE];
    }
    // SSE configuration - create if any SSE-related environment variables are set
    const hasAnySSEConfig = exports.ENV_CONFIG.SSE_PORT in process.env ||
        exports.ENV_CONFIG.SSE_HOST in process.env ||
        exports.ENV_CONFIG.SSE_ENDPOINT in process.env ||
        exports.ENV_CONFIG.CORS_ORIGINS in process.env ||
        exports.ENV_CONFIG.CORS_CREDENTIALS in process.env ||
        exports.ENV_CONFIG.HEALTH_CHECK_ENABLED in process.env ||
        exports.ENV_CONFIG.HEALTH_CHECK_ENDPOINT in process.env;
    if (config.type === 'sse' || hasAnySSEConfig) {
        const ssePortEnv = process.env[exports.ENV_CONFIG.SSE_PORT];
        config.sse = {
            port: ssePortEnv ? parseInt(ssePortEnv) : 8080,
            host: process.env[exports.ENV_CONFIG.SSE_HOST] || 'localhost',
            endpoint: process.env[exports.ENV_CONFIG.SSE_ENDPOINT] || '/sse',
            cors: {
                enabled: process.env[exports.ENV_CONFIG.CORS_ORIGINS] !== undefined,
                origins: process.env[exports.ENV_CONFIG.CORS_ORIGINS]?.split(',') ?? ['*'],
                credentials: process.env[exports.ENV_CONFIG.CORS_CREDENTIALS] === 'true',
            },
            healthCheck: {
                enabled: process.env[exports.ENV_CONFIG.HEALTH_CHECK_ENABLED] !== 'false',
                endpoint: process.env[exports.ENV_CONFIG.HEALTH_CHECK_ENDPOINT] || '/health',
            },
        };
    }
    return config;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2plcmVteXBhcmtlci9EZXNrdG9wL0NsYXVkZSBDb2RpbmcgUHJvamVjdHMvbjhuLW1jcC1zZXJ2ZXIvc3JjL3RyYW5zcG9ydC90cmFuc3BvcnRDb25maWcudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUE2RUgsc0RBd0JDO0FBS0QsMERBRUM7QUFLRCxvQ0FRQztBQTBCRCxnREFxQ0M7QUF0TEQsNkJBQXdCO0FBRXhCLGlDQUFpQztBQUNwQixRQUFBLHFCQUFxQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDNUMsSUFBSSxFQUFFLE9BQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO0lBQy9DLEdBQUcsRUFBRSxPQUFDO1NBQ0gsTUFBTSxDQUFDO1FBQ04sSUFBSSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDbkQsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ3BDLElBQUksRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQztRQUNyQyxJQUFJLEVBQUUsT0FBQzthQUNKLE1BQU0sQ0FBQztZQUNOLE9BQU8sRUFBRSxPQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztZQUNsQyxPQUFPLEVBQUUsT0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMzQyxXQUFXLEVBQUUsT0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7U0FDeEMsQ0FBQzthQUNELE9BQU8sQ0FBQyxFQUFFLENB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QUFXLEVBQUU7Z0JBQ1gsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLE9BQU87Z0JBQ2pFLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFVLENBQUMscUJBQXFCLENBQUMsSUFBSSxTQUFTO2FBQ3JFO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9qZXJlbXlwYXJrZXIvRGVza3RvcC9DbGF1ZGUgQ29kaW5nIFByb2plY3RzL244bi1tY3Atc2VydmVyL3NyYy90cmFuc3BvcnQvdHJhbnNwb3J0Q29uZmlnLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVHJhbnNwb3J0IENvbmZpZ3VyYXRpb24gZm9yIG44biBNQ1AgU2VydmVyXG4gKlxuICogUHJvdmlkZXMgdHJhbnNwb3J0IHR5cGUgZGV0ZWN0aW9uIGFuZCBjb25maWd1cmF0aW9uIGZvciBkaWZmZXJlbnQgZGVwbG95bWVudCBzY2VuYXJpb3MuXG4gKiBTdXBwb3J0cyBib3RoIHN0ZGlvIChsb2NhbCBkZXZlbG9wbWVudCkgYW5kIFNTRSAocmVtb3RlL3dlYiBhY2Nlc3MpIHRyYW5zcG9ydHMuXG4gKi9cblxuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5cbi8vIFRyYW5zcG9ydCBjb25maWd1cmF0aW9uIHNjaGVtYVxuZXhwb3J0IGNvbnN0IFRyYW5zcG9ydENvbmZpZ1NjaGVtYSA9IHoub2JqZWN0KHtcbiAgdHlwZTogei5lbnVtKFsnc3RkaW8nLCAnc3NlJ10pLmRlZmF1bHQoJ3N0ZGlvJyksXG4gIHNzZTogelxuICAgIC5vYmplY3Qoe1xuICAgICAgcG9ydDogei5udW1iZXIoKS5taW4oMTAyNCkubWF4KDY1NTM1KS5kZWZhdWx0KDgwODApLFxuICAgICAgZW5kcG9pbnQ6IHouc3RyaW5nKCkuZGVmYXVsdCgnL3NzZScpLFxuICAgICAgaG9zdDogei5zdHJpbmcoKS5kZWZhdWx0KCdsb2NhbGhvc3QnKSxcbiAgICAgIGNvcnM6IHpcbiAgICAgICAgLm9iamVjdCh7XG4gICAgICAgICAgZW5hYmxlZDogei5ib29sZWFuKCkuZGVmYXVsdCh0cnVlKSxcbiAgICAgICAgICBvcmlnaW5zOiB6LmFycmF5KHouc3RyaW5nKCkpLmRlZmF1bHQoWycqJ10pLFxuICAgICAgICAgIGNyZWRlbnRpYWxzOiB6LmJvb2xlYW4oKS5kZWZhdWx0KGZhbHNlKSxcbiAgICAgICAgfSlcbiAgICAgICAgLmRlZmF1bHQoe30pLFxuICAgICAgaGVhbHRoQ2hlY2s6IHpcbiAgICAgICAgLm9iamVjdCh7XG4gICAgICAgICAgZW5hYmxlZDogei5ib29sZWFuKCkuZGVmYXVsdCh0cnVlKSxcbiAgICAgICAgICBlbmRwb2ludDogei5zdHJpbmcoKS5kZWZhdWx0KCcvaGVhbHRoJyksXG4gICAgICAgIH0pXG4gICAgICAgIC5kZWZhdWx0KHt9KSxcbiAgICB9KVxuICAgIC5vcHRpb25hbCgpLFxufSk7XG5cbmV4cG9ydCB0eXBlIFRyYW5zcG9ydENvbmZpZyA9IHouaW5mZXI8dHlwZW9mIFRyYW5zcG9ydENvbmZpZ1NjaGVtYT47XG5cbi8qKlxuICogRGVmYXVsdCB0cmFuc3BvcnQgY29uZmlndXJhdGlvbnMgZm9yIGRpZmZlcmVudCBlbnZpcm9ubWVudHNcbiAqL1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfQ09ORklHUyA9IHtcbiAgZGV2ZWxvcG1lbnQ6IHtcbiAgICB0eXBlOiAnc3RkaW8nIGFzIGNvbnN0LFxuICB9LFxuICBwcm9kdWN0aW9uOiB7XG4gICAgdHlwZTogJ3NzZScgYXMgY29uc3QsXG4gICAgc3NlOiB7XG4gICAgICBwb3J0OiA4MDgwLFxuICAgICAgZW5kcG9pbnQ6ICcvc3NlJyxcbiAgICAgIGhvc3Q6ICcwLjAuMC4wJyxcbiAgICAgIGNvcnM6IHtcbiAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgb3JpZ2luczogWycqJ10sXG4gICAgICAgIGNyZWRlbnRpYWxzOiBmYWxzZSxcbiAgICAgIH0sXG4gICAgICBoZWFsdGhDaGVjazoge1xuICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICBlbmRwb2ludDogJy9oZWFsdGgnLFxuICAgICAgfSxcbiAgICB9LFxuICB9LFxuICB3ZWI6IHtcbiAgICB0eXBlOiAnc3NlJyBhcyBjb25zdCxcbiAgICBzc2U6IHtcbiAgICAgIHBvcnQ6IHByb2Nlc3MuZW52LlBPUlQgPyBwYXJzZUludChwcm9jZXNzLmVudi5QT1JUKSA6IDMwMDAsXG4gICAgICBlbmRwb2ludDogJy9zc2UnLFxuICAgICAgaG9zdDogJzAuMC4wLjAnLFxuICAgICAgY29yczoge1xuICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICBvcmlnaW5zOiBwcm9jZXNzLmVudi5DT1JTX09SSUdJTlM/LnNwbGl0KCcsJykgfHwgWycqJ10sXG4gICAgICAgIGNyZWRlbnRpYWxzOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIGhlYWx0aENoZWNrOiB7XG4gICAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICAgIGVuZHBvaW50OiAnL2hlYWx0aCcsXG4gICAgICB9LFxuICAgIH0sXG4gIH0sXG59IGFzIGNvbnN0O1xuXG4vKipcbiAqIERldGVjdCBhcHByb3ByaWF0ZSB0cmFuc3BvcnQgY29uZmlndXJhdGlvbiBiYXNlZCBvbiBlbnZpcm9ubWVudFxuICovXG5leHBvcnQgZnVuY3Rpb24gZGV0ZWN0VHJhbnNwb3J0Q29uZmlnKCk6IFRyYW5zcG9ydENvbmZpZyB7XG4gIC8vIENoZWNrIGVudmlyb25tZW50IHZhcmlhYmxlcyBmb3IgZXhwbGljaXQgdHJhbnNwb3J0IHR5cGVcbiAgY29uc3QgdHJhbnNwb3J0VHlwZSA9IHByb2Nlc3MuZW52Lk44Tl9NQ1BfVFJBTlNQT1JUIGFzICdzdGRpbycgfCAnc3NlJyB8IHVuZGVmaW5lZDtcblxuICBpZiAodHJhbnNwb3J0VHlwZSA9PT0gJ3NzZScpIHtcbiAgICByZXR1cm4gREVGQVVMVF9DT05GSUdTLndlYjtcbiAgfVxuXG4gIGlmICh0cmFuc3BvcnRUeXBlID09PSAnc3RkaW8nKSB7XG4gICAgcmV0dXJuIERFRkFVTFRfQ09ORklHUy5kZXZlbG9wbWVudDtcbiAgfVxuXG4gIC8vIEF1dG8tZGV0ZWN0IGJhc2VkIG9uIGVudmlyb25tZW50XG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nIHx8IHByb2Nlc3MuZW52LlBPUlQpIHtcbiAgICByZXR1cm4gREVGQVVMVF9DT05GSUdTLndlYjtcbiAgfVxuXG4gIC8vIENoZWNrIGlmIHJ1bm5pbmcgaW4gYSB3ZWIgZW52aXJvbm1lbnQgKFJhaWx3YXksIFZlcmNlbCwgZXRjLilcbiAgaWYgKHByb2Nlc3MuZW52LlJBSUxXQVlfRU5WSVJPTk1FTlQgfHwgcHJvY2Vzcy5lbnYuVkVSQ0VMIHx8IHByb2Nlc3MuZW52LlJFTkRFUikge1xuICAgIHJldHVybiBERUZBVUxUX0NPTkZJR1Mud2ViO1xuICB9XG5cbiAgLy8gRGVmYXVsdCB0byBzdGRpbyBmb3IgbG9jYWwgZGV2ZWxvcG1lbnRcbiAgcmV0dXJuIERFRkFVTFRfQ09ORklHUy5kZXZlbG9wbWVudDtcbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSBhbmQgbm9ybWFsaXplIHRyYW5zcG9ydCBjb25maWd1cmF0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVRyYW5zcG9ydENvbmZpZyhjb25maWc6IHVua25vd24pOiBUcmFuc3BvcnRDb25maWcge1xuICByZXR1cm4gVHJhbnNwb3J0Q29uZmlnU2NoZW1hLnBhcnNlKGNvbmZpZyk7XG59XG5cbi8qKlxuICogR2V0IFNTRSBzZXJ2ZXIgVVJMIGZyb20gY29uZmlndXJhdGlvblxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VydmVyVXJsKGNvbmZpZzogVHJhbnNwb3J0Q29uZmlnKTogc3RyaW5nIHwgbnVsbCB7XG4gIGlmIChjb25maWcudHlwZSAhPT0gJ3NzZScgfHwgIWNvbmZpZy5zc2UpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHsgaG9zdCwgcG9ydCwgZW5kcG9pbnQgfSA9IGNvbmZpZy5zc2U7XG4gIGNvbnN0IHByb3RvY29sID0gcG9ydCA9PT0gNDQzID8gJ2h0dHBzJyA6ICdodHRwJztcbiAgcmV0dXJuIGAke3Byb3RvY29sfTovLyR7aG9zdH06JHtwb3J0fSR7ZW5kcG9pbnR9YDtcbn1cblxuLyoqXG4gKiBFbnZpcm9ubWVudCB2YXJpYWJsZSBjb25maWd1cmF0aW9uIGhlbHBlcnNcbiAqL1xuZXhwb3J0IGNvbnN0IEVOVl9DT05GSUcgPSB7XG4gIC8vIFRyYW5zcG9ydCB0eXBlIHNlbGVjdGlvblxuICBUUkFOU1BPUlRfVFlQRTogJ044Tl9NQ1BfVFJBTlNQT1JUJywgLy8gJ3N0ZGlvJyB8ICdzc2UnXG5cbiAgLy8gU1NFIGNvbmZpZ3VyYXRpb25cbiAgU1NFX1BPUlQ6ICdOOE5fTUNQX1NTRV9QT1JUJyxcbiAgU1NFX0hPU1Q6ICdOOE5fTUNQX1NTRV9IT1NUJyxcbiAgU1NFX0VORFBPSU5UOiAnTjhOX01DUF9TU0VfRU5EUE9JTlQnLFxuXG4gIC8vIENPUlMgY29uZmlndXJhdGlvblxuICBDT1JTX09SSUdJTlM6ICdOOE5fTUNQX0NPUlNfT1JJR0lOUycsIC8vIGNvbW1hLXNlcGFyYXRlZCBsaXN0XG4gIENPUlNfQ1JFREVOVElBTFM6ICdOOE5fTUNQX0NPUlNfQ1JFREVOVElBTFMnLCAvLyAndHJ1ZScgfCAnZmFsc2UnXG5cbiAgLy8gSGVhbHRoIGNoZWNrIGNvbmZpZ3VyYXRpb25cbiAgSEVBTFRIX0NIRUNLX0VOQUJMRUQ6ICdOOE5fTUNQX0hFQUxUSF9DSEVDS19FTkFCTEVEJyxcbiAgSEVBTFRIX0NIRUNLX0VORFBPSU5UOiAnTjhOX01DUF9IRUFMVEhfQ0hFQ0tfRU5EUE9JTlQnLFxufSBhcyBjb25zdDtcblxuLyoqXG4gKiBQYXJzZSB0cmFuc3BvcnQgY29uZmlndXJhdGlvbiBmcm9tIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VDb25maWdGcm9tRW52KCk6IFBhcnRpYWw8VHJhbnNwb3J0Q29uZmlnPiB7XG4gIGNvbnN0IGNvbmZpZzogUGFydGlhbDxUcmFuc3BvcnRDb25maWc+ID0ge307XG5cbiAgLy8gVHJhbnNwb3J0IHR5cGVcbiAgaWYgKHByb2Nlc3MuZW52W0VOVl9DT05GSUcuVFJBTlNQT1JUX1RZUEVdKSB7XG4gICAgY29uZmlnLnR5cGUgPSBwcm9jZXNzLmVudltFTlZfQ09ORklHLlRSQU5TUE9SVF9UWVBFXSBhcyAnc3RkaW8nIHwgJ3NzZSc7XG4gIH1cblxuICAvLyBTU0UgY29uZmlndXJhdGlvbiAtIGNyZWF0ZSBpZiBhbnkgU1NFLXJlbGF0ZWQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGFyZSBzZXRcbiAgY29uc3QgaGFzQW55U1NFQ29uZmlnID1cbiAgICBFTlZfQ09ORklHLlNTRV9QT1JUIGluIHByb2Nlc3MuZW52IHx8XG4gICAgRU5WX0NPTkZJRy5TU0VfSE9TVCBpbiBwcm9jZXNzLmVudiB8fFxuICAgIEVOVl9DT05GSUcuU1NFX0VORFBPSU5UIGluIHByb2Nlc3MuZW52IHx8XG4gICAgRU5WX0NPTkZJRy5DT1JTX09SSUdJTlMgaW4gcHJvY2Vzcy5lbnYgfHxcbiAgICBFTlZfQ09ORklHLkNPUlNfQ1JFREVOVElBTFMgaW4gcHJvY2Vzcy5lbnYgfHxcbiAgICBFTlZfQ09ORklHLkhFQUxUSF9DSEVDS19FTkFCTEVEIGluIHByb2Nlc3MuZW52IHx8XG4gICAgRU5WX0NPTkZJRy5IRUFMVEhfQ0hFQ0tfRU5EUE9JTlQgaW4gcHJvY2Vzcy5lbnY7XG5cbiAgaWYgKGNvbmZpZy50eXBlID09PSAnc3NlJyB8fCBoYXNBbnlTU0VDb25maWcpIHtcbiAgICBjb25zdCBzc2VQb3J0RW52ID0gcHJvY2Vzcy5lbnZbRU5WX0NPTkZJRy5TU0VfUE9SVF07XG4gICAgY29uZmlnLnNzZSA9IHtcbiAgICAgIHBvcnQ6IHNzZVBvcnRFbnYgPyBwYXJzZUludChzc2VQb3J0RW52KSA6IDgwODAsXG4gICAgICBob3N0OiBwcm9jZXNzLmVudltFTlZfQ09ORklHLlNTRV9IT1NUXSB8fCAnbG9jYWxob3N0JyxcbiAgICAgIGVuZHBvaW50OiBwcm9jZXNzLmVudltFTlZfQ09ORklHLlNTRV9FTkRQT0lOVF0gfHwgJy9zc2UnLFxuICAgICAgY29yczoge1xuICAgICAgICBlbmFibGVkOiBwcm9jZXNzLmVudltFTlZfQ09ORklHLkNPUlNfT1JJR0lOU10gIT09IHVuZGVmaW5lZCxcbiAgICAgICAgb3JpZ2luczogcHJvY2Vzcy5lbnZbRU5WX0NPTkZJRy5DT1JTX09SSUdJTlNdPy5zcGxpdCgnLCcpID8/IFsnKiddLFxuICAgICAgICBjcmVkZW50aWFsczogcHJvY2Vzcy5lbnZbRU5WX0NPTkZJRy5DT1JTX0NSRURFTlRJQUxTXSA9PT0gJ3RydWUnLFxuICAgICAgfSxcbiAgICAgIGhlYWx0aENoZWNrOiB7XG4gICAgICAgIGVuYWJsZWQ6IHByb2Nlc3MuZW52W0VOVl9DT05GSUcuSEVBTFRIX0NIRUNLX0VOQUJMRURdICE9PSAnZmFsc2UnLFxuICAgICAgICBlbmRwb2ludDogcHJvY2Vzcy5lbnZbRU5WX0NPTkZJRy5IRUFMVEhfQ0hFQ0tfRU5EUE9JTlRdIHx8ICcvaGVhbHRoJyxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiBjb25maWc7XG59XG4iXSwidmVyc2lvbiI6M30=