03d07422df9c31bf3288dcc7bc853c35
"use strict";
/**
 * Workflow Resources for n8n MCP Server
 *
 * Provides MCP resources for accessing n8n workflow data including definitions,
 * metadata, and configuration. Supports both static workflow access and dynamic
 * workflow discovery.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.WorkflowResourceManager = void 0;
exports.createWorkflowResources = createWorkflowResources;
/**
 * Workflow resource manager
 *
 * Manages workflow-related MCP resources including individual workflow access,
 * workflow listings, and workflow metadata.
 */
class WorkflowResourceManager {
    config;
    cache = new Map();
    constructor(config = {}) {
        this.config = {
            baseUri: 'n8n://workflows',
            maxWorkflows: 100,
            includeInactive: true,
            includeExecutions: false,
            cacheDuration: 5 * 60 * 1000, // 5 minutes
            ...config,
        };
    }
    /**
     * Register workflow resources with FastMCP server
     */
    register(server, getClient) {
        // Individual workflow resource template
        server.addResourceTemplate({
            uriTemplate: `${this.config.baseUri}/{id}`,
            name: 'n8n Workflow',
            mimeType: 'application/json',
            arguments: [
                {
                    name: 'id',
                    description: 'The ID of the n8n workflow',
                    required: true,
                },
            ],
            load: async ({ id }) => {
                const client = getClient();
                if (!client) {
                    throw new Error('n8n client not initialized. Run init-n8n first.');
                }
                const workflow = await this.getWorkflowResource(client, id);
                return {
                    text: JSON.stringify(workflow, null, 2),
                };
            },
        });
        // Workflow listing resource
        server.addResource({
            uri: `${this.config.baseUri}/list`,
            name: 'n8n Workflow List',
            mimeType: 'application/json',
            load: async () => {
                const client = getClient();
                if (!client) {
                    throw new Error('n8n client not initialized. Run init-n8n first.');
                }
                const workflows = await this.getWorkflowListResource(client);
                return {
                    text: JSON.stringify(workflows, null, 2),
                };
            },
        });
        // Active workflows resource
        server.addResource({
            uri: `${this.config.baseUri}/active`,
            name: 'n8n Active Workflows',
            mimeType: 'application/json',
            load: async () => {
                const client = getClient();
                if (!client) {
                    throw new Error('n8n client not initialized. Run init-n8n first.');
                }
                const activeWorkflows = await this.getActiveWorkflowsResource(client);
                return {
                    text: JSON.stringify(activeWorkflows, null, 2),
                };
            },
        });
        // Workflow statistics resource
        server.addResource({
            uri: `${this.config.baseUri}/stats`,
            name: 'n8n Workflow Statistics',
            mimeType: 'application/json',
            load: async () => {
                const client = getClient();
                if (!client) {
                    throw new Error('n8n client not initialized. Run init-n8n first.');
                }
                const stats = await this.getWorkflowStatsResource(client);
                return {
                    text: JSON.stringify(stats, null, 2),
                };
            },
        });
        // Workflow resource template for pattern matching
        server.addResourceTemplate({
            uriTemplate: `${this.config.baseUri}/{workflowId}`,
            name: 'n8n Workflow by ID',
            mimeType: 'application/json',
            arguments: [
                {
                    name: 'workflowId',
                    description: 'The ID of the n8n workflow',
                    required: true,
                },
            ],
            load: async ({ workflowId }) => {
                const client = getClient();
                if (!client) {
                    throw new Error('n8n client not initialized. Run init-n8n first.');
                }
                const workflow = await this.getWorkflowResource(client, workflowId);
                return {
                    text: JSON.stringify(workflow, null, 2),
                };
            },
        });
        console.log('ðŸ“„ Workflow resources registered');
    }
    /**
     * Get individual workflow resource
     */
    async getWorkflowResource(client, workflowId) {
        const cacheKey = `workflow:${workflowId}`;
        const cached = this.getCachedData(cacheKey);
        if (cached) {
            return cached;
        }
        try {
            const workflow = await client.getWorkflow(workflowId);
            // Enhance workflow data with metadata
            const enhancedWorkflow = {
                ...workflow,
                metadata: {
                    id: workflow.id,
                    name: workflow.name,
                    active: workflow.active,
                    tags: workflow.tags || [],
                    createdAt: workflow.createdAt,
                    updatedAt: workflow.updatedAt,
                    nodeCount: workflow.nodes?.length || 0,
                    connectionCount: workflow.connections ? Object.keys(workflow.connections).length : 0,
                },
                resourceInfo: {
                    uri: `${this.config.baseUri}/${workflowId}`,
                    type: 'n8n-workflow',
                    version: '1.0',
                    lastAccessed: new Date().toISOString(),
                },
            };
            this.setCachedData(cacheKey, enhancedWorkflow);
            return enhancedWorkflow;
        }
        catch (error) {
            throw new Error(`Failed to load workflow ${workflowId}: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    /**
     * Get workflow list resource
     */
    async getWorkflowListResource(client) {
        const cacheKey = 'workflows:list';
        const cached = this.getCachedData(cacheKey);
        if (cached) {
            return cached;
        }
        try {
            const workflows = await client.getWorkflows({
                limit: this.config.maxWorkflows,
            });
            const workflowList = {
                workflows: workflows.data.map(workflow => ({
                    id: workflow.id,
                    name: workflow.name,
                    active: workflow.active,
                    tags: workflow.tags || [],
                    createdAt: workflow.createdAt,
                    updatedAt: workflow.updatedAt,
                    uri: `${this.config.baseUri}/${workflow.id}`,
                })),
                metadata: {
                    total: workflows.data.length, // API doesn't provide total count
                    returned: workflows.data.length,
                    includeInactive: this.config.includeInactive,
                    maxWorkflows: this.config.maxWorkflows,
                },
                resourceInfo: {
                    uri: `${this.config.baseUri}/list`,
                    type: 'n8n-workflow-list',
                    version: '1.0',
                    lastAccessed: new Date().toISOString(),
                },
            };
            this.setCachedData(cacheKey, workflowList);
            return workflowList;
        }
        catch (error) {
            throw new Error(`Failed to load workflow list: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    /**
     * Get active workflows resource
     */
    async getActiveWorkflowsResource(client) {
        const cacheKey = 'workflows:active';
        const cached = this.getCachedData(cacheKey);
        if (cached) {
            return cached;
        }
        try {
            const workflows = await client.getWorkflows({
                limit: this.config.maxWorkflows,
            });
            // Filter for active workflows client-side
            const activeWorkflowsData = workflows.data.filter(w => w.active);
            const activeWorkflows = {
                activeWorkflows: activeWorkflowsData.map(workflow => ({
                    id: workflow.id,
                    name: workflow.name,
                    tags: workflow.tags || [],
                    lastExecution: workflow.updatedAt,
                    uri: `${this.config.baseUri}/${workflow.id}`,
                })),
                metadata: {
                    total: activeWorkflowsData.length,
                    returned: activeWorkflowsData.length,
                    activeOnly: true,
                },
                resourceInfo: {
                    uri: `${this.config.baseUri}/active`,
                    type: 'n8n-active-workflows',
                    version: '1.0',
                    lastAccessed: new Date().toISOString(),
                },
            };
            this.setCachedData(cacheKey, activeWorkflows);
            return activeWorkflows;
        }
        catch (error) {
            throw new Error(`Failed to load active workflows: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    /**
     * Get workflow statistics resource
     */
    async getWorkflowStatsResource(client) {
        const cacheKey = 'workflows:stats';
        const cached = this.getCachedData(cacheKey);
        if (cached) {
            return cached;
        }
        try {
            const workflows = await client.getWorkflows({
                limit: this.config.maxWorkflows,
            });
            const stats = {
                totalWorkflows: workflows.data.length,
                activeWorkflows: workflows.data.filter(w => w.active).length,
                inactiveWorkflows: workflows.data.filter(w => !w.active).length,
                tagUsage: this.calculateTagUsage(workflows.data),
                creationStats: this.calculateCreationStats(workflows.data),
                resourceInfo: {
                    uri: `${this.config.baseUri}/stats`,
                    type: 'n8n-workflow-stats',
                    version: '1.0',
                    lastAccessed: new Date().toISOString(),
                },
            };
            this.setCachedData(cacheKey, stats);
            return stats;
        }
        catch (error) {
            throw new Error(`Failed to load workflow statistics: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    /**
     * Calculate tag usage statistics
     */
    calculateTagUsage(workflows) {
        const tagUsage = {};
        workflows.forEach(workflow => {
            if (workflow.tags && Array.isArray(workflow.tags)) {
                workflow.tags.forEach((tag) => {
                    const tagName = typeof tag === 'string' ? tag : tag.name;
                    tagUsage[tagName] = (tagUsage[tagName] || 0) + 1;
                });
            }
        });
        return tagUsage;
    }
    /**
     * Calculate creation statistics
     */
    calculateCreationStats(workflows) {
        const now = new Date();
        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        return {
            createdLastWeek: workflows.filter(w => new Date(w.createdAt) > oneWeekAgo).length,
            createdLastMonth: workflows.filter(w => new Date(w.createdAt) > oneMonthAgo).length,
            updatedLastWeek: workflows.filter(w => new Date(w.updatedAt) > oneWeekAgo).length,
            updatedLastMonth: workflows.filter(w => new Date(w.updatedAt) > oneMonthAgo).length,
        };
    }
    /**
     * Get cached data if not expired
     */
    getCachedData(key) {
        const cached = this.cache.get(key);
        if (cached && cached.expires > Date.now()) {
            return cached.data;
        }
        return null;
    }
    /**
     * Set cached data with expiration
     */
    setCachedData(key, data) {
        if (this.config.cacheDuration > 0) {
            this.cache.set(key, {
                data,
                expires: Date.now() + this.config.cacheDuration,
            });
        }
    }
    /**
     * Clear resource cache
     */
    clearCache() {
        this.cache.clear();
    }
    /**
     * Get cache statistics
     */
    getCacheStats() {
        return {
            size: this.cache.size,
            keys: Array.from(this.cache.keys()),
        };
    }
}
exports.WorkflowResourceManager = WorkflowResourceManager;
/**
 * Create workflow resource manager
 */
function createWorkflowResources(config) {
    return new WorkflowResourceManager(config);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2plcmVteXBhcmtlci9EZXNrdG9wL0NsYXVkZSBDb2RpbmcgUHJvamVjdHMvbjhuLW1jcC1zZXJ2ZXIvc3JjL3Jlc291cmNlcy93b3JrZmxvd1Jlc291cmNlcy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOzs7QUE0WkgsMERBRUM7QUFyWUQ7Ozs7O0dBS0c7QUFDSCxNQUFhLHVCQUF1QjtJQUMxQixNQUFNLENBQW1DO0lBQ3pDLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBMEMsQ0FBQztJQUVsRSxZQUFZLFNBQWlDLEVBQUU7UUFDN0MsSUFBSSxDQUFDLE1BQU0sR0FBRztZQUNaLE9BQU8sRUFBRSxpQkFBaUI7WUFDMUIsWUFBWSxFQUFFLEdBQUc7WUFDakIsZUFBZSxFQUFFLElBQUk7WUFDckIsaUJBQWlCLEVBQUUsS0FBSztZQUN4QixhQUFhLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsWUFBWTtZQUMxQyxHQUFHLE1BQU07U0FDVixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ksUUFBUSxDQUFDLE1BQWUsRUFBRSxTQUFpQztRQUNoRSx3Q0FBd0M7UUFDeEMsTUFBTSxDQUFDLG1CQUFtQixDQUFDO1lBQ3pCLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxPQUFPO1lBQzFDLElBQUksRUFBRSxjQUFjO1lBQ3BCLFFBQVEsRUFBRSxrQkFBa0I7WUFDNUIsU0FBUyxFQUFFO2dCQUNUO29CQUNFLElBQUksRUFBRSxJQUFJO29CQUNWLFdBQVcsRUFBRSw0QkFBNEI7b0JBQ3pDLFFBQVEsRUFBRSxJQUFJO2lCQUNmO2FBQ0Y7WUFDRCxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFrQixFQUFFLEVBQUU7Z0JBQ3JDLE1BQU0sTUFBTSxHQUFHLFNBQVMsRUFBRSxDQUFDO2dCQUMzQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxpREFBaUQsQ0FBQyxDQUFD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QyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksYUFBYTtRQUNsQixPQUFPO1lBQ0wsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtZQUNyQixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3BDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUF4WEQsMERBd1hDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQix1QkFBdUIsQ0FBQyxNQUErQjtJQUNyRSxPQUFPLElBQUksdUJBQXVCLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0MsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvamVyZW15cGFya2VyL0Rlc2t0b3AvQ2xhdWRlIENvZGluZyBQcm9qZWN0cy9uOG4tbWNwLXNlcnZlci9zcmMvcmVzb3VyY2VzL3dvcmtmbG93UmVzb3VyY2VzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogV29ya2Zsb3cgUmVzb3VyY2VzIGZvciBuOG4gTUNQIFNlcnZlclxuICpcbiAqIFByb3ZpZGVzIE1DUCByZXNvdXJjZXMgZm9yIGFjY2Vzc2luZyBuOG4gd29ya2Zsb3cgZGF0YSBpbmNsdWRpbmcgZGVmaW5pdGlvbnMsXG4gKiBtZXRhZGF0YSwgYW5kIGNvbmZpZ3VyYXRpb24uIFN1cHBvcnRzIGJvdGggc3RhdGljIHdvcmtmbG93IGFjY2VzcyBhbmQgZHluYW1pY1xuICogd29ya2Zsb3cgZGlzY292ZXJ5LlxuICovXG5cbmltcG9ydCB7IEZhc3RNQ1AgfSBmcm9tICdmYXN0bWNwJztcbmltcG9ydCB7IE44bkNsaWVudCB9IGZyb20gJy4uL2NsaWVudC9uOG5DbGllbnQuanMnO1xuXG4vKipcbiAqIFdvcmtmbG93IHJlc291cmNlIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBXb3JrZmxvd1Jlc291cmNlQ29uZmlnIHtcbiAgLyoqIEJhc2UgVVJJIHByZWZpeCBmb3Igd29ya2Zsb3cgcmVzb3VyY2VzICovXG4gIGJhc2VVcmk/OiBzdHJpbmc7XG5cbiAgLyoqIE1heGltdW0gbnVtYmVyIG9mIHdvcmtmbG93cyB0byBpbmNsdWRlIGluIGxpc3RpbmdzICovXG4gIG1heFdvcmtmbG93cz86IG51bWJlcjtcblxuICAvKiogV2hldGhlciB0byBpbmNsdWRlIGluYWN0aXZlIHdvcmtmbG93cyAqL1xuICBpbmNsdWRlSW5hY3RpdmU/OiBib29sZWFuO1xuXG4gIC8qKiBXaGV0aGVyIHRvIGluY2x1ZGUgd29ya2Zsb3cgZXhlY3V0aW9uIGhpc3RvcnkgKi9cbiAgaW5jbHVkZUV4ZWN1dGlvbnM/OiBib29sZWFuO1xuXG4gIC8qKiBDYWNoZSBkdXJhdGlvbiBmb3Igd29ya2Zsb3cgZGF0YSAobXMpICovXG4gIGNhY2hlRHVyYXRpb24/OiBudW1iZXI7XG59XG5cbi8qKlxuICogV29ya2Zsb3cgcmVzb3VyY2UgbWFuYWdlclxuICpcbiAqIE1hbmFnZXMgd29ya2Zsb3ctcmVsYXRlZCBNQ1AgcmVzb3VyY2VzIGluY2x1ZGluZyBpbmRpdmlkdWFsIHdvcmtmbG93IGFjY2VzcyxcbiAqIHdvcmtmbG93IGxpc3RpbmdzLCBhbmQgd29ya2Zsb3cgbWV0YWRhdGEuXG4gKi9cbmV4cG9ydCBjbGFzcyBXb3JrZmxvd1Jlc291cmNlTWFuYWdlciB7XG4gIHByaXZhdGUgY29uZmlnOiBSZXF1aXJlZDxXb3JrZmxvd1Jlc291cmNlQ29uZmlnPjtcbiAgcHJpdmF0ZSBjYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCB7IGRhdGE6IGFueTsgZXhwaXJlczogbnVtYmVyIH0+KCk7XG5cbiAgY29uc3RydWN0b3IoY29uZmlnOiBXb3JrZmxvd1Jlc291cmNlQ29uZmlnID0ge30pIHtcbiAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgIGJhc2VVcmk6ICduOG46Ly93b3JrZmxvd3MnLFxuICAgICAgbWF4V29ya2Zsb3dzOiAxMDAsXG4gICAgICBpbmNsdWRlSW5hY3RpdmU6IHRydWUsXG4gICAgICBpbmNsdWRlRXhlY3V0aW9uczogZmFsc2UsXG4gICAgICBjYWNoZUR1cmF0aW9uOiA1ICogNjAgKiAxMDAwLCAvLyA1IG1pbnV0ZXNcbiAgICAgIC4uLmNvbmZpZyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIHdvcmtmbG93IHJlc291cmNlcyB3aXRoIEZhc3RNQ1Agc2VydmVyXG4gICAqL1xuICBwdWJsaWMgcmVnaXN0ZXIoc2VydmVyOiBGYXN0TUNQLCBnZXRDbGllbnQ6ICgpID0+IE44bkNsaWVudCB8IG51bGwpOiB2b2lkIHtcbiAgICAvLyBJbmRpdmlkdWFsIHdvcmtmbG93IHJlc291cmNlIHRlbXBsYXRlXG4gICAgc2VydmVyLmFkZFJlc291cmNlVGVtcGxhdGUoe1xuICAgICAgdXJpVGVtcGxhdGU6IGAke3RoaXMuY29uZmlnLmJhc2VVcml9L3tpZH1gLFxuICAgICAgbmFtZTogJ244biBXb3JrZmxvdycsXG4gICAgICBtaW1lVHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgYXJndW1lbnRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiAnaWQnLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIElEIG9mIHRoZSBuOG4gd29ya2Zsb3cnLFxuICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIGxvYWQ6IGFzeW5jICh7IGlkIH06IHsgaWQ6IHN0cmluZyB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IGdldENsaWVudCgpO1xuICAgICAgICBpZiAoIWNsaWVudCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbjhuIGNsaWVudCBub3QgaW5pdGlhbGl6ZWQuIFJ1biBpbml0LW44biBmaXJzdC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHdvcmtmbG93ID0gYXdhaXQgdGhpcy5nZXRXb3JrZmxvd1Jlc291cmNlKGNsaWVudCwgaWQpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHRleHQ6IEpTT04uc3RyaW5naWZ5KHdvcmtmbG93LCBudWxsLCAyKSxcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBXb3JrZmxvdyBsaXN0aW5nIHJlc291cmNlXG4gICAgc2VydmVyLmFkZFJlc291cmNlKHtcbiAgICAgIHVyaTogYCR7dGhpcy5jb25maWcuYmFzZVVyaX0vbGlzdGAsXG4gICAgICBuYW1lOiAnbjhuIFdvcmtmbG93IExpc3QnLFxuICAgICAgbWltZVR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgIGxvYWQ6IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gZ2V0Q2xpZW50KCk7XG4gICAgICAgIGlmICghY2xpZW50KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCduOG4gY2xpZW50IG5vdCBpbml0aWFsaXplZC4gUnVuIGluaXQtbjhuIGZpcnN0LicpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgd29ya2Zsb3dzID0gYXdhaXQgdGhpcy5nZXRXb3JrZmxvd0xpc3RSZXNvdXJjZShjbGllbnQpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHRleHQ6IEpTT04uc3RyaW5naWZ5KHdvcmtmbG93cywgbnVsbCwgMiksXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQWN0aXZlIHdvcmtmbG93cyByZXNvdXJjZVxuICAgIHNlcnZlci5hZGRSZXNvdXJjZSh7XG4gICAgICB1cmk6IGAke3RoaXMuY29uZmlnLmJhc2VVcml9L2FjdGl2ZWAsXG4gICAgICBuYW1lOiAnbjhuIEFjdGl2ZSBXb3JrZmxvd3MnLFxuICAgICAgbWltZVR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgIGxvYWQ6IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gZ2V0Q2xpZW50KCk7XG4gICAgICAgIGlmICghY2xpZW50KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCduOG4gY2xpZW50IG5vdCBpbml0aWFsaXplZC4gUnVuIGluaXQtbjhuIGZpcnN0LicpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYWN0aXZlV29ya2Zsb3dzID0gYXdhaXQgdGhpcy5nZXRBY3RpdmVXb3JrZmxvd3NSZXNvdXJjZShjbGllbnQpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHRleHQ6IEpTT04uc3RyaW5naWZ5KGFjdGl2ZVdvcmtmbG93cywgbnVsbCwgMiksXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gV29ya2Zsb3cgc3RhdGlzdGljcyByZXNvdXJjZVxuICAgIHNlcnZlci5hZGRSZXNvdXJjZSh7XG4gICAgICB1cmk6IGAke3RoaXMuY29uZmlnLmJhc2VVcml9L3N0YXRzYCxcbiAgICAgIG5hbWU6ICduOG4gV29ya2Zsb3cgU3RhdGlzdGljcycsXG4gICAgICBtaW1lVHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgbG9hZDogYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBnZXRDbGllbnQoKTtcbiAgICAgICAgaWYgKCFjbGllbnQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ244biBjbGllbnQgbm90IGluaXRpYWxpemVkLiBSdW4gaW5pdC1uOG4gZmlyc3QuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdGF0cyA9IGF3YWl0IHRoaXMuZ2V0V29ya2Zsb3dTdGF0c1Jlc291cmNlKGNsaWVudCk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdGV4dDogSlNPTi5zdHJpbmdpZnkoc3RhdHMsIG51bGwsIDIpLFxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIFdvcmtmbG93IHJlc291cmNlIHRlbXBsYXRlIGZvciBwYXR0ZXJuIG1hdGNoaW5nXG4gICAgc2VydmVyLmFkZFJlc291cmNlVGVtcGxhdGUoe1xuICAgICAgdXJpVGVtcGxhdGU6IGAke3RoaXMuY29uZmlnLmJhc2VVcml9L3t3b3JrZmxvd0lkfWAsXG4gICAgICBuYW1lOiAnbjhuIFdvcmtmbG93IGJ5IElEJyxcbiAgICAgIG1pbWVUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICBhcmd1bWVudHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIG5hbWU6ICd3b3JrZmxvd0lkJyxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBJRCBvZiB0aGUgbjhuIHdvcmtmbG93JyxcbiAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBsb2FkOiBhc3luYyAoeyB3b3JrZmxvd0lkIH06IHsgd29ya2Zsb3dJZDogc3RyaW5nIH0pID0+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gZ2V0Q2xpZW50KCk7XG4gICAgICAgIGlmICghY2xpZW50KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCduOG4gY2xpZW50IG5vdCBpbml0aWFsaXplZC4gUnVuIGluaXQtbjhuIGZpcnN0LicpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgd29ya2Zsb3cgPSBhd2FpdCB0aGlzLmdldFdvcmtmbG93UmVzb3VyY2UoY2xpZW50LCB3b3JrZmxvd0lkKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0ZXh0OiBKU09OLnN0cmluZ2lmeSh3b3JrZmxvdywgbnVsbCwgMiksXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgY29uc29sZS5sb2coJ/Cfk4QgV29ya2Zsb3cgcmVzb3VyY2VzIHJlZ2lzdGVyZWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgaW5kaXZpZHVhbCB3b3JrZmxvdyByZXNvdXJjZVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZXRXb3JrZmxvd1Jlc291cmNlKGNsaWVudDogTjhuQ2xpZW50LCB3b3JrZmxvd0lkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGNhY2hlS2V5ID0gYHdvcmtmbG93OiR7d29ya2Zsb3dJZH1gO1xuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuZ2V0Q2FjaGVkRGF0YShjYWNoZUtleSk7XG4gICAgaWYgKGNhY2hlZCkge1xuICAgICAgcmV0dXJuIGNhY2hlZDtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qgd29ya2Zsb3cgPSBhd2FpdCBjbGllbnQuZ2V0V29ya2Zsb3cod29ya2Zsb3dJZCk7XG5cbiAgICAgIC8vIEVuaGFuY2Ugd29ya2Zsb3cgZGF0YSB3aXRoIG1ldGFkYXRhXG4gICAgICBjb25zdCBlbmhhbmNlZFdvcmtmbG93ID0ge1xuICAgICAgICAuLi53b3JrZmxvdyxcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICBpZDogd29ya2Zsb3cuaWQsXG4gICAgICAgICAgbmFtZTogd29ya2Zsb3cubmFtZSxcbiAgICAgICAgICBhY3RpdmU6IHdvcmtmbG93LmFjdGl2ZSxcbiAgICAgICAgICB0YWdzOiB3b3JrZmxvdy50YWdzIHx8IFtdLFxuICAgICAgICAgIGNyZWF0ZWRBdDogd29ya2Zsb3cuY3JlYXRlZEF0LFxuICAgICAgICAgIHVwZGF0ZWRBdDogd29ya2Zsb3cudXBkYXRlZEF0LFxuICAgICAgICAgIG5vZGVDb3VudDogd29ya2Zsb3cubm9kZXM/Lmxlbmd0aCB8fCAwLFxuICAgICAgICAgIGNvbm5lY3Rpb25Db3VudDogd29ya2Zsb3cuY29ubmVjdGlvbnMgPyBPYmplY3Qua2V5cyh3b3JrZmxvdy5jb25uZWN0aW9ucykubGVuZ3RoIDogMCxcbiAgICAgICAgfSxcbiAgICAgICAgcmVzb3VyY2VJbmZvOiB7XG4gICAgICAgICAgdXJpOiBgJHt0aGlzLmNvbmZpZy5iYXNlVXJpfS8ke3dvcmtmbG93SWR9YCxcbiAgICAgICAgICB0eXBlOiAnbjhuLXdvcmtmbG93JyxcbiAgICAgICAgICB2ZXJzaW9uOiAnMS4wJyxcbiAgICAgICAgICBsYXN0QWNjZXNzZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIHRoaXMuc2V0Q2FjaGVkRGF0YShjYWNoZUtleSwgZW5oYW5jZWRXb3JrZmxvdyk7XG4gICAgICByZXR1cm4gZW5oYW5jZWRXb3JrZmxvdztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgd29ya2Zsb3cgJHt3b3JrZmxvd0lkfTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHdvcmtmbG93IGxpc3QgcmVzb3VyY2VcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0V29ya2Zsb3dMaXN0UmVzb3VyY2UoY2xpZW50OiBOOG5DbGllbnQpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGNhY2hlS2V5ID0gJ3dvcmtmbG93czpsaXN0JztcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmdldENhY2hlZERhdGEoY2FjaGVLZXkpO1xuICAgIGlmIChjYWNoZWQpIHtcbiAgICAgIHJldHVybiBjYWNoZWQ7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHdvcmtmbG93cyA9IGF3YWl0IGNsaWVudC5nZXRXb3JrZmxvd3Moe1xuICAgICAgICBsaW1pdDogdGhpcy5jb25maWcubWF4V29ya2Zsb3dzLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHdvcmtmbG93TGlzdCA9IHtcbiAgICAgICAgd29ya2Zsb3dzOiB3b3JrZmxvd3MuZGF0YS5tYXAod29ya2Zsb3cgPT4gKHtcbiAgICAgICAgICBpZDogd29ya2Zsb3cuaWQsXG4gICAgICAgICAgbmFtZTogd29ya2Zsb3cubmFtZSxcbiAgICAgICAgICBhY3RpdmU6IHdvcmtmbG93LmFjdGl2ZSxcbiAgICAgICAgICB0YWdzOiB3b3JrZmxvdy50YWdzIHx8IFtdLFxuICAgICAgICAgIGNyZWF0ZWRBdDogd29ya2Zsb3cuY3JlYXRlZEF0LFxuICAgICAgICAgIHVwZGF0ZWRBdDogd29ya2Zsb3cudXBkYXRlZEF0LFxuICAgICAgICAgIHVyaTogYCR7dGhpcy5jb25maWcuYmFzZVVyaX0vJHt3b3JrZmxvdy5pZH1gLFxuICAgICAgICB9KSksXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgdG90YWw6IHdvcmtmbG93cy5kYXRhLmxlbmd0aCwgLy8gQVBJIGRvZXNuJ3QgcHJvdmlkZSB0b3RhbCBjb3VudFxuICAgICAgICAgIHJldHVybmVkOiB3b3JrZmxvd3MuZGF0YS5sZW5ndGgsXG4gICAgICAgICAgaW5jbHVkZUluYWN0aXZlOiB0aGlzLmNvbmZpZy5pbmNsdWRlSW5hY3RpdmUsXG4gICAgICAgICAgbWF4V29ya2Zsb3dzOiB0aGlzLmNvbmZpZy5tYXhXb3JrZmxvd3MsXG4gICAgICAgIH0sXG4gICAgICAgIHJlc291cmNlSW5mbzoge1xuICAgICAgICAgIHVyaTogYCR7dGhpcy5jb25maWcuYmFzZVVyaX0vbGlzdGAsXG4gICAgICAgICAgdHlwZTogJ244bi13b3JrZmxvdy1saXN0JyxcbiAgICAgICAgICB2ZXJzaW9uOiAnMS4wJyxcbiAgICAgICAgICBsYXN0QWNjZXNzZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIHRoaXMuc2V0Q2FjaGVkRGF0YShjYWNoZUtleSwgd29ya2Zsb3dMaXN0KTtcbiAgICAgIHJldHVybiB3b3JrZmxvd0xpc3Q7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBsb2FkIHdvcmtmbG93IGxpc3Q6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhY3RpdmUgd29ya2Zsb3dzIHJlc291cmNlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldEFjdGl2ZVdvcmtmbG93c1Jlc291cmNlKGNsaWVudDogTjhuQ2xpZW50KTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBjYWNoZUtleSA9ICd3b3JrZmxvd3M6YWN0aXZlJztcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmdldENhY2hlZERhdGEoY2FjaGVLZXkpO1xuICAgIGlmIChjYWNoZWQpIHtcbiAgICAgIHJldHVybiBjYWNoZWQ7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHdvcmtmbG93cyA9IGF3YWl0IGNsaWVudC5nZXRXb3JrZmxvd3Moe1xuICAgICAgICBsaW1pdDogdGhpcy5jb25maWcubWF4V29ya2Zsb3dzLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEZpbHRlciBmb3IgYWN0aXZlIHdvcmtmbG93cyBjbGllbnQtc2lkZVxuICAgICAgY29uc3QgYWN0aXZlV29ya2Zsb3dzRGF0YSA9IHdvcmtmbG93cy5kYXRhLmZpbHRlcih3ID0+IHcuYWN0aXZlKTtcblxuICAgICAgY29uc3QgYWN0aXZlV29ya2Zsb3dzID0ge1xuICAgICAgICBhY3RpdmVXb3JrZmxvd3M6IGFjdGl2ZVdvcmtmbG93c0RhdGEubWFwKHdvcmtmbG93ID0+ICh7XG4gICAgICAgICAgaWQ6IHdvcmtmbG93LmlkLFxuICAgICAgICAgIG5hbWU6IHdvcmtmbG93Lm5hbWUsXG4gICAgICAgICAgdGFnczogd29ya2Zsb3cudGFncyB8fCBbXSxcbiAgICAgICAgICBsYXN0RXhlY3V0aW9uOiB3b3JrZmxvdy51cGRhdGVkQXQsXG4gICAgICAgICAgdXJpOiBgJHt0aGlzLmNvbmZpZy5iYXNlVXJpfS8ke3dvcmtmbG93LmlkfWAsXG4gICAgICAgIH0pKSxcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICB0b3RhbDogYWN0aXZlV29ya2Zsb3dzRGF0YS5sZW5ndGgsXG4gICAgICAgICAgcmV0dXJuZWQ6IGFjdGl2ZVdvcmtmbG93c0RhdGEubGVuZ3RoLFxuICAgICAgICAgIGFjdGl2ZU9ubHk6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICAgIHJlc291cmNlSW5mbzoge1xuICAgICAgICAgIHVyaTogYCR7dGhpcy5jb25maWcuYmFzZVVyaX0vYWN0aXZlYCxcbiAgICAgICAgICB0eXBlOiAnbjhuLWFjdGl2ZS13b3JrZmxvd3MnLFxuICAgICAgICAgIHZlcnNpb246ICcxLjAnLFxuICAgICAgICAgIGxhc3RBY2Nlc3NlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgdGhpcy5zZXRDYWNoZWREYXRhKGNhY2hlS2V5LCBhY3RpdmVXb3JrZmxvd3MpO1xuICAgICAgcmV0dXJuIGFjdGl2ZVdvcmtmbG93cztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgYWN0aXZlIHdvcmtmbG93czogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHdvcmtmbG93IHN0YXRpc3RpY3MgcmVzb3VyY2VcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0V29ya2Zsb3dTdGF0c1Jlc291cmNlKGNsaWVudDogTjhuQ2xpZW50KTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBjYWNoZUtleSA9ICd3b3JrZmxvd3M6c3RhdHMnO1xuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuZ2V0Q2FjaGVkRGF0YShjYWNoZUtleSk7XG4gICAgaWYgKGNhY2hlZCkge1xuICAgICAgcmV0dXJuIGNhY2hlZDtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qgd29ya2Zsb3dzID0gYXdhaXQgY2xpZW50LmdldFdvcmtmbG93cyh7XG4gICAgICAgIGxpbWl0OiB0aGlzLmNvbmZpZy5tYXhXb3JrZmxvd3MsXG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgc3RhdHMgPSB7XG4gICAgICAgIHRvdGFsV29ya2Zsb3dzOiB3b3JrZmxvd3MuZGF0YS5sZW5ndGgsXG4gICAgICAgIGFjdGl2ZVdvcmtmbG93czogd29ya2Zsb3dzLmRhdGEuZmlsdGVyKHcgPT4gdy5hY3RpdmUpLmxlbmd0aCxcbiAgICAgICAgaW5hY3RpdmVXb3JrZmxvd3M6IHdvcmtmbG93cy5kYXRhLmZpbHRlcih3ID0+ICF3LmFjdGl2ZSkubGVuZ3RoLFxuICAgICAgICB0YWdVc2FnZTogdGhpcy5jYWxjdWxhdGVUYWdVc2FnZSh3b3JrZmxvd3MuZGF0YSksXG4gICAgICAgIGNyZWF0aW9uU3RhdHM6IHRoaXMuY2FsY3VsYXRlQ3JlYXRpb25TdGF0cyh3b3JrZmxvd3MuZGF0YSksXG4gICAgICAgIHJlc291cmNlSW5mbzoge1xuICAgICAgICAgIHVyaTogYCR7dGhpcy5jb25maWcuYmFzZVVyaX0vc3RhdHNgLFxuICAgICAgICAgIHR5cGU6ICduOG4td29ya2Zsb3ctc3RhdHMnLFxuICAgICAgICAgIHZlcnNpb246ICcxLjAnLFxuICAgICAgICAgIGxhc3RBY2Nlc3NlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgdGhpcy5zZXRDYWNoZWREYXRhKGNhY2hlS2V5LCBzdGF0cyk7XG4gICAgICByZXR1cm4gc3RhdHM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBsb2FkIHdvcmtmbG93IHN0YXRpc3RpY3M6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSB0YWcgdXNhZ2Ugc3RhdGlzdGljc1xuICAgKi9cbiAgcHJpdmF0ZSBjYWxjdWxhdGVUYWdVc2FnZSh3b3JrZmxvd3M6IGFueVtdKTogUmVjb3JkPHN0cmluZywgbnVtYmVyPiB7XG4gICAgY29uc3QgdGFnVXNhZ2U6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcblxuICAgIHdvcmtmbG93cy5mb3JFYWNoKHdvcmtmbG93ID0+IHtcbiAgICAgIGlmICh3b3JrZmxvdy50YWdzICYmIEFycmF5LmlzQXJyYXkod29ya2Zsb3cudGFncykpIHtcbiAgICAgICAgd29ya2Zsb3cudGFncy5mb3JFYWNoKCh0YWc6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHRhZ05hbWUgPSB0eXBlb2YgdGFnID09PSAnc3RyaW5nJyA/IHRhZyA6IHRhZy5uYW1lO1xuICAgICAgICAgIHRhZ1VzYWdlW3RhZ05hbWVdID0gKHRhZ1VzYWdlW3RhZ05hbWVdIHx8IDApICsgMTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGFnVXNhZ2U7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIGNyZWF0aW9uIHN0YXRpc3RpY3NcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlQ3JlYXRpb25TdGF0cyh3b3JrZmxvd3M6IGFueVtdKTogYW55IHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IG9uZVdlZWtBZ28gPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpIC0gNyAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgIGNvbnN0IG9uZU1vbnRoQWdvID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDMwICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgY3JlYXRlZExhc3RXZWVrOiB3b3JrZmxvd3MuZmlsdGVyKHcgPT4gbmV3IERhdGUody5jcmVhdGVkQXQpID4gb25lV2Vla0FnbykubGVuZ3RoLFxuICAgICAgY3JlYXRlZExhc3RNb250aDogd29ya2Zsb3dzLmZpbHRlcih3ID0+IG5ldyBEYXRlKHcuY3JlYXRlZEF0KSA+IG9uZU1vbnRoQWdvKS5sZW5ndGgsXG4gICAgICB1cGRhdGVkTGFzdFdlZWs6IHdvcmtmbG93cy5maWx0ZXIodyA9PiBuZXcgRGF0ZSh3LnVwZGF0ZWRBdCkgPiBvbmVXZWVrQWdvKS5sZW5ndGgsXG4gICAgICB1cGRhdGVkTGFzdE1vbnRoOiB3b3JrZmxvd3MuZmlsdGVyKHcgPT4gbmV3IERhdGUody51cGRhdGVkQXQpID4gb25lTW9udGhBZ28pLmxlbmd0aCxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjYWNoZWQgZGF0YSBpZiBub3QgZXhwaXJlZFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRDYWNoZWREYXRhKGtleTogc3RyaW5nKTogYW55IHwgbnVsbCB7XG4gICAgY29uc3QgY2FjaGVkID0gdGhpcy5jYWNoZS5nZXQoa2V5KTtcbiAgICBpZiAoY2FjaGVkICYmIGNhY2hlZC5leHBpcmVzID4gRGF0ZS5ub3coKSkge1xuICAgICAgcmV0dXJuIGNhY2hlZC5kYXRhO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgY2FjaGVkIGRhdGEgd2l0aCBleHBpcmF0aW9uXG4gICAqL1xuICBwcml2YXRlIHNldENhY2hlZERhdGEoa2V5OiBzdHJpbmcsIGRhdGE6IGFueSk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNvbmZpZy5jYWNoZUR1cmF0aW9uID4gMCkge1xuICAgICAgdGhpcy5jYWNoZS5zZXQoa2V5LCB7XG4gICAgICAgIGRhdGEsXG4gICAgICAgIGV4cGlyZXM6IERhdGUubm93KCkgKyB0aGlzLmNvbmZpZy5jYWNoZUR1cmF0aW9uLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIHJlc291cmNlIGNhY2hlXG4gICAqL1xuICBwdWJsaWMgY2xlYXJDYWNoZSgpOiB2b2lkIHtcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNhY2hlIHN0YXRpc3RpY3NcbiAgICovXG4gIHB1YmxpYyBnZXRDYWNoZVN0YXRzKCk6IHsgc2l6ZTogbnVtYmVyOyBrZXlzOiBzdHJpbmdbXSB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgc2l6ZTogdGhpcy5jYWNoZS5zaXplLFxuICAgICAga2V5czogQXJyYXkuZnJvbSh0aGlzLmNhY2hlLmtleXMoKSksXG4gICAgfTtcbiAgfVxufVxuXG4vKipcbiAqIENyZWF0ZSB3b3JrZmxvdyByZXNvdXJjZSBtYW5hZ2VyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVXb3JrZmxvd1Jlc291cmNlcyhjb25maWc/OiBXb3JrZmxvd1Jlc291cmNlQ29uZmlnKTogV29ya2Zsb3dSZXNvdXJjZU1hbmFnZXIge1xuICByZXR1cm4gbmV3IFdvcmtmbG93UmVzb3VyY2VNYW5hZ2VyKGNvbmZpZyk7XG59XG4iXSwidmVyc2lvbiI6M30=